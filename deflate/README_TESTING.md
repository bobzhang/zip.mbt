# DEFLATE Testing with Python Reference Implementation

This directory contains tools to verify the MoonBit DEFLATE implementation against Python's `zlib` module, which is a widely-used reference implementation of RFC 1951.

## Python Scripts

### 1. `generate_test_data.py`

Generates comprehensive test cases using Python's zlib as the reference implementation.

**Usage:**
```bash
python3 deflate/generate_test_data.py
```

**Output:**
- `deflate/test_data.json` - JSON file with all test cases (hex data, compression ratios, etc.)
- `deflate/deflate_python_compat_test.mbt` - Auto-generated MoonBit test file

**Test Cases Generated:**
- Empty data
- Single byte
- Repeated patterns (10, 100, 1000 bytes)
- ASCII text (hello world, lorem ipsum)
- Binary sequences (0-255)
- Highly compressible patterns
- Mixed content
- All zeros (maximum compression)
- Different compression levels (0, 1, 6, 9)
- Pathological cases (alternating, long matches)
- Real-world JSON data
- Large text (performance test)

### 2. `verify_deflate.py`

Interactive tool for verifying DEFLATE data against Python's implementation.

**Usage:**

Decompress data:
```bash
python3 deflate/verify_deflate.py --decompress "0300"
```

Compress data:
```bash
python3 deflate/verify_deflate.py --compress "48656c6c6f" --level 6
```

Roundtrip test:
```bash
python3 deflate/verify_deflate.py --roundtrip "48656c6c6f"
```

Interactive mode:
```bash
python3 deflate/verify_deflate.py --interactive
```

## Testing Workflow

### 1. Generate Test Data

```bash
# Generate test cases from Python zlib
python3 deflate/generate_test_data.py

# This creates:
# - deflate/test_data.json (reference data)
# - deflate/deflate_python_compat_test.mbt (MoonBit tests)
```

### 2. Run MoonBit Tests

```bash
# Run all deflate tests
moon test --target wasm-gc -p deflate

# Run only Python compatibility tests
moon test --target wasm-gc -p deflate -f deflate_python_compat_test.mbt
```

### 3. Verify Specific Cases

If a test fails, you can use the verification script to debug:

```bash
# Get hex data from the failing test in test_data.json
# Then verify with Python:
python3 deflate/verify_deflate.py --decompress "<compressed_hex>"

# Or test the input data:
python3 deflate/verify_deflate.py --compress "<input_hex>"
```

### 4. Interactive Debugging

```bash
python3 deflate/verify_deflate.py --interactive

> decompress 0300
> compress 48656c6c6f
> roundtrip 48656c6c6f
> quit
```

## Understanding Test Results

### Expected Behavior

1. **Decompression Tests**: MoonBit should correctly decompress Python-generated DEFLATE data
   - ✓ Tests pass if decompressed output matches original input

2. **Compression Tests**: MoonBit and Python may produce different compressed outputs
   - Different encoder implementations make different valid choices
   - ✓ Tests pass if both outputs decompress to the same input
   - Exact byte-for-byte match is rare and not required

3. **Roundtrip Tests**: Compress with MoonBit, decompress with MoonBit
   - ✓ Tests pass if roundtrip produces original input

### Compression Ratio Examples

| Test Case | Input Size | Compressed Size | Ratio |
|-----------|-----------|----------------|-------|
| Empty | 0 | 3 | N/A |
| Single byte | 1 | 5 | 500% |
| Repeated 100 | 100 | 8-12 | 8-12% |
| ASCII text | 500 | 250-300 | 50-60% |
| Binary random | 256 | 260+ | >100% |
| All zeros | 1000 | 10-15 | 1-2% |

## RFC 1951 Compliance

The test data generated by Python's zlib is compliant with:
- **RFC 1951**: DEFLATE Compressed Data Format Specification

This ensures that the MoonBit implementation is verified against a known-good reference implementation used by millions of applications worldwide.

## Coverage Analysis

After running tests, check coverage:

```bash
moon coverage analyze -p deflate
```

The Python-generated tests help cover:
- Various compression levels
- Different data patterns
- Edge cases (empty, single byte, large data)
- Real-world scenarios (text, JSON, binary)

## Troubleshooting

### Test Failures

1. Check the error message - is it decompression or compression?
2. Extract hex data from `test_data.json`
3. Verify with Python: `python3 deflate/verify_deflate.py --decompress <hex>`
4. Compare with MoonBit behavior

### Compression Differences

If MoonBit produces different compressed output than Python:
- This is **expected** and **acceptable**
- Both are valid DEFLATE streams if they decompress correctly
- Different encoders make different choices (literal vs match, static vs dynamic Huffman, etc.)

### Python Environment

Requires Python 3.6+ with standard library (no external dependencies).

```bash
python3 --version  # Should be 3.6 or higher
```

## References

- [RFC 1951](https://tools.ietf.org/html/rfc1951) - DEFLATE Specification
- [Python zlib documentation](https://docs.python.org/3/library/zlib.html)
- [DEFLATE on Wikipedia](https://en.wikipedia.org/wiki/Deflate)
